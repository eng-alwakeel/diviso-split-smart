

# إصلاح: استبعاد المستخدمين المسجلين مسبقاً من الإحالات

## المشكلة
عند إضافة عضو لمجموعة، النظام ينشئ سجل إحالة (`group_invite`) تلقائياً بدون التحقق إن كان الشخص مسجلاً مسبقاً. النتيجة: **جميع** الإحالات من نوع `group_invite` حالياً هي لأشخاص مسجلين من قبل ولا يجب حسابهم كإحالات.

## الحل (مرحلتان)

### المرحلة 1: تصفية في `useReferralStats.ts`
إضافة فلتر في الـ frontend يستبعد الإحالات التي كان المدعو مسجلاً قبلها:

- بعد جلب الإحالات، استخراج user IDs من `invitee_phone` (بصيغة `group_member_UUID`)
- جلب `created_at` لهؤلاء المستخدمين من جدول `profiles`
- مقارنة تاريخ إنشاء البروفايل مع تاريخ الإحالة
- استبعاد أي إحالة يكون فيها البروفايل مُنشأ قبل الإحالة بأكثر من ساعة واحدة

### المرحلة 2: منع الإنشاء من المصدر
تحديث الكود الذي ينشئ إحالات `group_invite` (في `process-referral-signup` أو منطق المجموعات) للتحقق أولاً من تاريخ تسجيل العضو قبل إنشاء سجل الإحالة. لكن هذا تغيير في Edge Function وسنركز الآن على المرحلة 1.

## التفاصيل التقنية

### الملف: `src/hooks/useReferralStats.ts`

بعد جلب الإحالات وقبل الـ deduplication:

1. جمع كل الـ user IDs من `invitee_phone` (التي تبدأ بـ `group_member_`)
2. استعلام `profiles` لجلب `created_at` لهذه الـ IDs
3. فلترة: استبعاد الإحالات التي `profile.created_at < referral.created_at - 1 hour`
4. متابعة المنطق الحالي (deduplication + progress mapping)

```text
التدفق الحالي:
  fetch referrals -> dedup -> map progress -> set stats

التدفق الجديد:
  fetch referrals -> filter pre-existing users -> dedup -> map progress -> set stats
```

### الملف: `src/hooks/useReferrals.ts`
تطبيق نفس الفلترة لضمان تطابق الإحصائيات في كلا الـ hook.

## الملفات المتأثرة

| الملف | التغيير |
|-------|---------|
| `src/hooks/useReferralStats.ts` | إضافة فلتر المستخدمين المسجلين مسبقاً |
| `src/hooks/useReferrals.ts` | نفس الفلتر لتطابق الإحصائيات |

## النتيجة
- Saud Thawab وجميع المستخدمين المسجلين مسبقاً لن يظهروا في مركز الإحالة
- فقط المستخدمون الذين سجلوا فعلاً عبر رابط الإحالة سيُحسبون
- الإحصائيات ستعكس الأرقام الحقيقية للإحالات الناجحة

