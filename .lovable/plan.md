

# نظام إرسال إيميلات إعلانية من لوحة الأدمن

## الهدف

بناء صفحة في لوحة الأدمن تمكّن الأدمن من كتابة إعلان (عنوان + محتوى) وإرساله لكل المسجلين عبر البريد الإلكتروني باستخدام Resend.

---

## المكونات المطلوبة

### 1. جدول قاعدة بيانات: `email_campaigns`

يحفظ سجل الحملات المرسلة لتتبعها لاحقا.

| العمود | النوع | الوصف |
|--------|-------|-------|
| id | uuid (PK) | المعرف |
| subject | text | عنوان الإيميل |
| body_html | text | محتوى الإيميل (HTML) |
| body_text | text | نص مختصر (plain text) |
| sent_by | uuid (FK profiles) | الأدمن المرسل |
| total_recipients | integer | عدد المستلمين |
| sent_count | integer | عدد المرسل فعلا |
| failed_count | integer | عدد الفاشل |
| status | text | حالة الحملة (draft/sending/completed/failed) |
| created_at | timestamptz | تاريخ الإنشاء |
| sent_at | timestamptz | تاريخ الإرسال |

**RLS**: قراءة وكتابة فقط للأدمن عبر `is_admin_user()`.

### 2. Edge Function: `send-broadcast-email`

- تستقبل: subject, body_html, body_text
- تتحقق من صلاحية الأدمن
- تجلب كل المستخدمين من `auth.admin.listUsers()` (باستخدام SERVICE_ROLE_KEY)
- ترسل الإيميلات على دفعات (batches) -- 50 إيميل كل دفعة مع تأخير بسيط لتجنب حدود Resend
- تحدّث جدول `email_campaigns` بالنتائج
- ترسل من: `noreply@diviso.app` (الدومين المفعّل)

### 3. كومبوننت أدمن: `AdminBroadcastEmail.tsx`

صفحة داخل تبويب جديد في لوحة الأدمن تحتوي:
- **نموذج الإرسال**: حقل العنوان + محقق نص المحتوى
- **معاينة**: عرض كيف سيبدو الإيميل قبل الإرسال
- **تأكيد**: نافذة تأكيد قبل الإرسال الفعلي تعرض عدد المستلمين
- **سجل الحملات**: جدول يعرض الحملات السابقة مع حالتها

### 4. تبويب جديد في لوحة الأدمن

- إضافة تبويب "البريد" (Broadcast) في `useAdminTabs.ts`
- صلاحية مطلوبة: `system.settings`
- يظهر فقط للـ owner و admin

---

## التسلسل التقني

```text
[أدمن يكتب الإعلان] 
    --> [ضغط إرسال] 
    --> [نافذة تأكيد]
    --> [استدعاء Edge Function]
    --> [Edge Function تجلب المستخدمين من auth.users]
    --> [إنشاء سجل في email_campaigns بحالة "sending"]
    --> [إرسال على دفعات عبر Resend]
    --> [تحديث السجل بالنتائج النهائية]
```

---

## الملفات المطلوبة

| الملف | النوع | الوصف |
|-------|-------|-------|
| Migration SQL | جديد | جدول email_campaigns + RLS |
| `supabase/functions/send-broadcast-email/index.ts` | جديد | Edge Function للإرسال |
| `supabase/config.toml` | تعديل | إضافة إعداد الدالة الجديدة |
| `src/components/admin/AdminBroadcastEmail.tsx` | جديد | واجهة كتابة وإرسال الإيميلات |
| `src/hooks/useAdminTabs.ts` | تعديل | إضافة تبويب "البريد" |
| `src/pages/AdminDashboard.tsx` | تعديل | عرض التبويب الجديد |

---

## ملاحظات مهمة

- **حد Resend المجاني**: 100 إيميل/يوم -- إذا عدد المسجلين اكبر، الدالة ترسل على دفعات وتسجّل الفشل
- **لا حاجة لسر جديد**: `RESEND_API_KEY` موجود بالفعل
- **الدومين**: الإرسال من `noreply@diviso.app` (الدومين المفعّل في Resend)
- **تصميم الإيميل**: قالب HTML عربي RTL متوافق مع هوية ديفيزو (مثل إيميلات الدعوة الحالية)
- **الإرسال التلقائي لاحقا**: البنية مصممة بحيث يمكن ربط trigger أو cron لاحقا لإرسال تلقائي عند إضافة ميزة جديدة

نضيف للصفحة نفسها النتفكيشن الي ممكن نعمله  داخل التطبيق 