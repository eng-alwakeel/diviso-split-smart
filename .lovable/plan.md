
المشكلة محددة الآن بشكل واضح، وهي ليست “تعليق قاعدة البيانات” بل Crash في الواجهة لهذه المجموعة فقط.

1) ما الذي يحدث فعلياً
- المجموعة التي اختبرت عليها فيها عضو واحد بحالة pending بدون حساب مسجل:
  - `group_id = 2600b96e-6abe-4720-8236-4f6f857035ce`
  - `user_id = NULL`
  - `phone_e164 = +966599791400`
- وعند فحص كل المجموعات، هذه هي المجموعة الوحيدة التي فيها عضو نشط (`archived_at IS NULL`) و`user_id = NULL`.
- هذا يفسر لماذا “مجموعة واحدة فقط” تتعطل.

2) السبب الجذري في الكود (Crash)
- في `src/pages/GroupDetails.tsx` يوجد منطق يفترض أن كل عضو لديه `user_id` نصي.
- في بطاقة النرد يتم تنفيذ:
  - `m.user_id.slice(0, 4)` (حوالي السطر 555)
- عندما يكون `user_id = NULL` (عضو pending من دعوة جوال)، يحصل خطأ runtime من نوع:
  - `Cannot read properties of null (reading 'slice')`
- هذا الخطأ يفعّل `PageErrorBoundary` ويظهر لك شاشة “حدث خطأ في تحميل هذه الصفحة”.

3) لماذا حصل بعد تجربة دعوة الجوال
- تدفق “إضافة مباشرة + رابط” أنشأ العضو pending بشكل صحيح (بدون user_id حتى يسجل).
- لكن صفحة تفاصيل المجموعة ما زالت مبنية على افتراض قديم: “كل عضو = مستخدم مسجل”.
- النتيجة: البيانات صحيحة، لكن الواجهة غير متوافقة مع نوع العضو pending.

4) خطة الإصلاح (تنفيذية)
المرحلة A — Hotfix سريع لمنع التعطل
- تعديل `GroupDetails.tsx` لمنع أي استخدام مباشر لـ `.slice()` على `user_id` غير موجود.
- أي مكان يحتاج أعضاء “مسجلين فقط” (مثل GroupDiceCard أو عمليات تعتمد user_id) يتم تمرير أعضاء بـ `user_id` صالح فقط.
- إضافة fallback آمن للاسم:
  - `display_name` من `group_members` إن وجد
  - ثم `profiles[...]`
  - ثم `phone_e164`
  - ثم نص افتراضي.

المرحلة B — توحيد نموذج الأعضاء لدعم pending/invited
- تحديث `useGroupData` ليعتبر `user_id` قابلًا لأن يكون null (Type + Transform).
- جلب حقول العضو اللازمة من `group_members` لعرض pending بشكل صحيح:
  - `status`, `phone_e164`, `display_name`
- عدم حصر العرض على `profiles` فقط لأن pending قد لا يملك profile.

المرحلة C — تعديل عرض تبويب الأعضاء
- في تبويب الأعضاء:
  - الأعضاء المسجلون: نفس `MemberCard` الحالي.
  - pending/invited بدون `user_id`: بطاقة مبسطة (اسم/جوال/الحالة) بدون Mini Profile وبدون إجراءات تعتمد user_id.
- الحفاظ على الشارات المطلوبة:
  - pending = “بانتظار التسجيل”
  - invited = “بانتظار الموافقة”

المرحلة D — تدقيق شامل لنقاط الحساسية
- مراجعة أي `members.map(m => m.user_id...)` في الصفحة نفسها لمنع أخطاء مماثلة:
  - `useMemberSubscriptions`
  - `PendingRatingsNotification`
  - `GroupDiceCard`
  - مفاتيح React (`key`) وأي index على `profiles[m.user_id]`.

5) نتيجة متوقعة بعد الإصلاح
- المجموعة الحالية ستفتح طبيعي ولن تظهر شاشة الخطأ.
- العضو pending سيظهر في القائمة بشكل صحيح بدل تكسير الصفحة.
- نفس التدفق سيبقى شغال: إضافة عضو + إنشاء رابط، ثم الربط يتم تلقائياً عند التسجيل بنفس الجوال.

6) اختبارات القبول بعد التنفيذ
- فتح المجموعة المتأثرة حالياً: لا يوجد Crash.
- وجود عضو pending بدون user_id: يظهر ببطاقة سليمة وحالة صحيحة.
- إضافة دعوة جوال جديدة لنفس المجموعة: لا يعلق العرض.
- المجموعات الأخرى (التي كل أعضائها مسجلون): لا يتغير سلوكها.
