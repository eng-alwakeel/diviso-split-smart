

# منع تكرار الأنشطة المقترحة بين أيام الخطة

## المشكلة

عند الضغط على "اقترح أنشطة" لكل يوم، الدالة `plan-day-ai-suggest` تعمل بشكل مستقل لكل يوم بدون معرفة الأنشطة الموجودة في الأيام الأخرى. النتيجة: تكرار نفس الأماكن (جبل الفيل، بلدة العلا القديمة، منطقة الجديدة) في الأيام الثلاثة.

## الحل

تعديل الدالة لجلب جميع الأنشطة الموجودة في كل أيام الخطة وإرسالها ضمن الـ prompt للذكاء الاصطناعي مع تعليمات واضحة بعدم التكرار.

---

## التعديل

### `supabase/functions/plan-day-ai-suggest/index.ts`

**3 تعديلات:**

1. **جلب الأنشطة الموجودة في كل الأيام** (بعد جلب بيانات الخطة -- سطر 163):

```text
// جديد: جلب كل الأنشطة الحالية في جميع أيام الخطة
- جلب كل plan_days المرتبطة بنفس plan_id
- جلب كل plan_day_activities لهذه الأيام
- تجميعها في قائمة بالعناوين + اليوم المرتبط بها
- استثناء اليوم الحالي (day_id) من القائمة
```

2. **تحديث الـ system prompt** (سطر 192-195) -- اضافة تعليمة واضحة:

```text
قبل:
"أنت مخطط رحلات ذكي. مهمتك اقتراح أنشطة ليوم محدد من خطة.
قدم 3-5 أنشطة مناسبة لموقع اليوم في الرحلة."

بعد:
"أنت مخطط رحلات ذكي. مهمتك اقتراح أنشطة ليوم محدد من خطة.
قدم 3-5 أنشطة مناسبة لموقع اليوم في الرحلة.
مهم جداً: لا تكرر أي نشاط أو مكان تم اقتراحه في أيام أخرى.
كل يوم يجب أن يحتوي على أماكن وتجارب مختلفة تماماً."
```

3. **تحديث الـ user prompt** (سطر 197-206) -- اضافة قائمة الأنشطة الموجودة:

```text
بعد التفاصيل الحالية، يُضاف:

"الأنشطة المقترحة مسبقاً في أيام أخرى (لا تكررها):
- اليوم 1: زيارة جبل الفيل، جولة في بلدة العلا القديمة، عشاء في الجديدة
- اليوم 2: جولة في الحجر (مدائن صالح)، تفت حرة عويرض
..."
```

---

## التفاصيل التقنية

### المنطق الجديد (قبل بناء الـ prompt)

```text
1. جلب كل الأيام: SELECT * FROM plan_days WHERE plan_id = X
2. جلب كل الأنشطة: SELECT * FROM plan_day_activities WHERE plan_day_id IN (dayIds)
3. تجميع أنشطة الأيام الأخرى (غير day_id الحالي) في نص:
   "اليوم 1: نشاط 1، نشاط 2"
   "اليوم 3: نشاط 1، نشاط 2"
4. إرسال هذا النص ضمن user prompt
```

### مثال على الـ prompt المحدّث

```text
تفاصيل الخطة:
- النوع: trip
- الوجهة: العلا
- التاريخ: 11/02/2026
- يوم 2 من 3 (يوم وسط)

الأنشطة المقترحة مسبقاً في أيام أخرى (يجب تجنب تكرارها بالكامل):
- اليوم 1: الاستمتاع بمطل جبل الفيل، جولة في بلدة العلا القديمة، عشاء في منطقة الجديدة
- اليوم 3: زيارة جبل الفيل، جولة في بلدة العلا القديمة، غداء في منطقة الجديدة

اقترح أنشطة جديدة ومختلفة تماماً لهذا اليوم.
```

---

## الملفات المعدلة

| الملف | التعديل |
|-------|--------|
| `supabase/functions/plan-day-ai-suggest/index.ts` | جلب أنشطة الأيام الأخرى + تحديث الـ prompt لمنع التكرار |

---

## النتيجة المتوقعة

- عند اقتراح أنشطة لليوم 2، يعرف الذكاء الاصطناعي ان جبل الفيل وبلدة العلا القديمة مقترحة في اليوم 1 و3 فيقترح أماكن مختلفة
- كل يوم يحصل على تجارب فريدة ومتنوعة
- لا تأثير على الأنشطة المضافة يدوياً من المستخدم

